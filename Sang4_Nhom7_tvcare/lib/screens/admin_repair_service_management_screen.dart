import 'package:flutter/material.dart';
import 'package:tvcare_flutter/services/repair_service_management_service.dart';
import '../models/repair_models.dart'; 
import 'package:intl/intl.dart';

class AdminRepairServiceManagementScreen extends StatefulWidget {
  const AdminRepairServiceManagementScreen({super.key});

  @override
  State<AdminRepairServiceManagementScreen> createState() => _AdminRepairServiceManagementScreenState();
}

class _AdminRepairServiceManagementScreenState extends State<AdminRepairServiceManagementScreen> {
  final RepairServiceManagementService _service = RepairServiceManagementService();
  List<RepairService> _services = [];
  bool _isLoading = true;

  @override
  void initState() {
    super.initState();
    _fetchServices();
  }

  Future<void> _fetchServices() async {
    if (!mounted) return;
    setState(() => _isLoading = true);
    try {
      final list = await _service.getAllServices();
      if (!mounted) return;
      setState(() {
        _services = list;
        _isLoading = false;
      });
    } catch (e) {
      if (!mounted) return;
      setState(() => _isLoading = false);
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Lỗi tải danh sách")));
    }
  }

  void _showAddDialog() {
    final nameController = TextEditingController();
    final descController = TextEditingController();
    final priceController = TextEditingController();

    showDialog(
      context: context,
      builder: (ctx) => AlertDialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        title: const Text("Thêm dịch vụ mới", style: TextStyle(fontWeight: FontWeight.bold)),
        content: SingleChildScrollView(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              TextField(
                controller: nameController,
                decoration: const InputDecoration(labelText: "Tên dịch vụ", border: OutlineInputBorder()),
              ),
              const SizedBox(height: 16),
              TextField(
                controller: descController,
                maxLines: 3,
                decoration: const InputDecoration(labelText: "Mô tả chi tiết", border: OutlineInputBorder()),
              ),
              const SizedBox(height: 16),
              TextField(
                controller: priceController,
                decoration: const InputDecoration(
                  labelText: "Giá dự kiến",
                  border: OutlineInputBorder(),
                  suffixText: "VND",
                ),
                keyboardType: TextInputType.number,
              ),
            ],
          ),
        ),
        actions: [
          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text("HỦY")),
          FilledButton(
            onPressed: () async {
              if (nameController.text.isEmpty) return;
              
              final newService = RepairService(
                id: 0, // ID is generated by the server
                serviceName: nameController.text.trim(),
                description: descController.text.trim(),
                estimatedPrice: double.tryParse(priceController.text) ?? 0,
                isActive: true, // Default to active
              );

              final success = await _service.createService(newService);
              if (success && mounted) {
                Navigator.pop(ctx);
                _fetchServices();
                ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Đã thêm dịch vụ thành công")));
              }
            },
            child: const Text("THÊM"),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final currencyFormat = NumberFormat.currency(locale: 'vi_VN', symbol: '₫');

    return Scaffold(
      appBar: AppBar(
        title: const Text("Quản lý Dịch vụ sửa chữa"),
        actions: [
          IconButton(onPressed: _fetchServices, icon: const Icon(Icons.refresh)),
          IconButton(onPressed: _showAddDialog, icon: const Icon(Icons.add)),
        ],
      ),
      body: _isLoading 
        ? const Center(child: CircularProgressIndicator())
        : Center(
          child: ConstrainedBox(
            constraints: const BoxConstraints(maxWidth: 1000),
            child: ListView(
              padding: const EdgeInsets.all(16.0),
              children: [DataTable(
                columns: const [
                  DataColumn(label: Text("Tên Dịch vụ")),
                  DataColumn(label: Text("Giá Dự Kiến")),
                  DataColumn(label: Text("Trạng thái")),
                ],
                rows: _services.map((service) {
                  return DataRow(cells: [
                    DataCell(Text(service.serviceName, style: const TextStyle(fontWeight: FontWeight.bold))),
                    DataCell(Text(currencyFormat.format(service.estimatedPrice))),
                    DataCell(
                      Switch(
                        value: service.isActive,
                        onChanged: (val) async {
                          final success = await _service.toggleService(service.id);
                          if (success && mounted) _fetchServices();
                        },
                      ),
                    ),
                  ]);
                }).toList(),
              )],
            ),
          ),
        ),
    );
  }
}
